/* eslint-disable no-undef */
// 上架商品
const fs = require('fs');
const path = require('path');
const csvtojson = require('csvtojson');
const { keccak256 } = require("web3-utils");
const { BigNumber } = require('ethers');
const { asciiToHex, encodePacked } = require("web3-utils");
const NFTStore = artifacts.require("NFTStore");
const Meland1155Wearable = artifacts.require("Meland1155Wearable");
const Meland1155Land = artifacts.require("Meland1155Land");
const Meland1155LandFuture = artifacts.require("Meland1155LandFuture");
const MelandTier = artifacts.require("MelandTier");

module.exports = async function (callback) {
    try {
        let network = config.network;
        if (![
            "matic",
            "mumbai",
            "develop",
            "rinkeby",
            "test"
        ].includes(network)) {
            console.log("Deploy only on polygon networks");
            callback()
            exit(0);
        }

        let accounts = await web3.eth.getAccounts();

        const Meland1155LandI = await Meland1155Land.deployed();
        const Meland1155WearableI = await Meland1155Wearable.deployed();
        const MelandTierI = await MelandTier.deployed();

        // common cid 89000001
        // rare cid 89000002
        // epic cid 89000003
        const map = {
            89000001: [
                {
                    cids: [
                        8900010,
                        8900011,
                        8900012,
                        8900013,
                    ],
                    num: 48
                },
                {
                    cids: [
                        8900014,
                        8900015,
                        8900016,
                        8900017,
                    ],
                    num: 48
                },
                {
                    cids: [
                        8900018,
                        8900019,
                        8900020,
                        8900021,
                    ],
                    num: 48
                },
                {
                    cids: [
                        8900022,
                        8900023,
                        8900024,
                        8900025,
                    ],
                    num: 26
                },
                {
                    cids: [
                        8900026,
                        8900027,
                        8900028,
                        8900029,
                    ],
                    num: 25
                },
                {
                    cids: [
                        8900030,
                        8900031,
                        8900032,
                        8900033,
                    ],
                    num: 10
                },
            ],
            89000002: [
                {
                    cids: [
                        8900010,
                        8900011,
                        8900012,
                        8900013
                    ],
                    num: 47
                },
                {
                    cids: [
                        8900014,
                        8900015,
                        8900016,
                        8900017
                    ],
                    num: 47
                },
                {
                    cids: [
                        8900018,
                        8900019,
                        8900020,
                        8900021
                    ],
                    num: 46
                },
                {
                    cids: [
                        8900022,
                        8900023,
                        8900024,
                        8900025
                    ],
                    num: 49
                },
                {
                    cids: [
                        8900026,
                        8900027,
                        8900028,
                        8900029
                    ],
                    num: 49
                },
                {
                    cids: [
                        8900030,
                        8900031,
                        8900032,
                        8900033
                    ],
                    num: 42
                },
            ],
            89000003: [
                {
                    cids: [
                        8900010,
                        8900011,
                        8900012,
                        8900013
                    ],
                    num: 18
                },
                {
                    cids: [
                        8900014,
                        8900015,
                        8900016,
                        8900017
                    ],
                    num: 18
                },
                {
                    cids: [
                        8900018,
                        8900019,
                        8900020,
                        8900021
                    ],
                    num: 18
                },
                {
                    cids: [
                        8900022,
                        8900023,
                        8900024,
                        8900025
                    ],
                    num: 41
                },
                {
                    cids: [
                        8900026,
                        8900027,
                        8900028,
                        8900029,
                    ],
                    num: 41
                },
                {
                    cids: [
                        8900030,
                        8900031,
                        8900032,
                        8900033,
                    ],
                    num: 45
                },
            ],
        };

        const ticketlandIdsStr = '6760519#7230516#6430424#7200514#6790399#7090484#7150513#6330419#6790359#7200559#7320389#6860557#6800517#7180564#6870514#6140448#7040516#6750478#6680532#6720509#6000363#6000428#6030434#6710522#6190491#6410561#6730386#7180478#6790446#7180383#6750368#7040511#6490384#6500394#6420413#6100457#6030415#6920479#7220529#5830390#6720516#7220546#6750551#6980477#6050455#6830410#5800385#7090383#6780531#6090427#6090447#6650490#6070402#6410386#7120490#7000385#6810556#6970483#6850551#6920375#7140538#7110479#6550548#6940520#6970523#6410451#6170543#6880508#6830405#5960431#7210484#7120366#7010470#6170427#7200496#6180415#5890424#6530388#7080506#5830373#5870441#6920550#7300376#6400376#7270502#6830528#6220371#6600430#6210418#6020422#5880399#7250391#6830515#6640385#6670482#7160361#6020441#6840459#6490404#5920394#6290422#6750449#6060374#7110470#6230548#6910387#6200409#6810426#7350366#6010456#6850379#6670553#7200449#7160558#6870547#7100542#5870411#6210500#7080537#7230458#6000379#5980460#7030392#6460419#6840388#6450385#6670505#5940460#6700393#7150465#5810395#6820373#7210503#7160531#6760363#6770384#6770486#6150389#7260494#6950531#6570459#5930401#6710525#6410406#6740529#6310549#6680563#6060367#5910387#6910380#6530395#7000377#6830470#7040379#5990447#6910404#6690430#7090522#6650368#6300555#6650467#6810551#6740390#7000523#6700380#6190372#7080392#6190550#6190392#6740541#6790411#6790546#6880372#7280471#6020466#6450409#7300392#6480398#7320463#6770373#6000373#6260385#5870394#7320453#6700550#6890484#5920427#6700540#7210508#6310386#6480433#6580532#6830394#6790524#6780542#7310459#7240511#6030377#6620529#7150472#6490448#6170403#6520455#6060532#6960467#6600558#6660412#6220376#6620452#6700368#6620535#6720427#6620408#6120383#6730400#6590546#7300370#6540421#6840533#7290381#7190387#6900361#6630365#6640501#6640380#6240454#6320529#6240413#6490389#7220491#6810568#6340545#5870416#7170459#6220383#6860520#5790391#6180454#6780431#5930420#6830562#6760560#6540370#6480559#6260450#6900400#7160526#6490413#6300452#6610510#5910442#6040461#6210443#6560452#5890391#6190449#7290365#6110529#6380414#6000385#6270371#6160420#7100547#6320442#6200505#5890458#6530408#7050528#6210424#7120514#6440403#6830545#6690546#5920406#6600446#6390370#7130558#6910471#6570390#6140429#6580382#6130452#6760377#6780394#6940516#6070451#5950445#6430436#6780508#7090518#6100524#7140550#6660547#5850368#5940468#6990360#6380558#6300365#7090555#6530381#6010397#6920463#7230563#6890552#7240477#6530402#6210538#7000505#6890457#7040505#6840361#7340371#5790406#6750395#6160359#6710373#5930379#6370457#6800363#6940496#6120362#6680408#6250421#6100390#6950399#6240405#6010368#6490373#5960395#6940393#5930448#6980388#6100405#6940364#5960424#7150388#6930526#6810383#6330369#6280535#6770467#6230430#7270481#6550446#6270531#6910537#6940535#7060388#6250366#6930370#7170494#6170384#5980376#7080551#6990528#7250465#6360387#6070385#6850539#6340449#6750457#6430446#6820478#7190537#6730503#6840400#6890442#6290409#6530439#6020451#6900502#6050448#7050384#6160533#6280440#6670449#7350376#6800379#6790389#6730381#6980370#7160392#7070474#6270550#6680386#6640559#7190466#6140368#7200364#6480440#6970511#6670474#6180432#6530414#6160523#5900464#6900523#6200387#6360540#6570552#6870467#6120417#6350529#7260507#7140382#6870434#6720405#6200510#6690399#6620541#6490368#6890530#7120392#7010373#5920367#6950382#7210462#6350381#6570418#6930555#6850486#7110387#5970411#6730463#7240386#6200518#6660537#7150483#5870371#6440380#6830522#6210437#6040427#6770402#6400427#6220399#5930371#6750525#7120507#6200363#6960489#6850445#5860376#6480379#7020515#5810378#6540464#7240367#6980554#5920436#6620458#6570408#7220523#6630549#6740564#6200528#7180488#6390420#7210392#6840439#6450370#6960375#7160542#6320537#6070420#7030368#7180547#6990364#5890453#6770406#6390534#6860367#6440558#6280417#7050523#6830432#6660541#7000509#7270388#6160528#5970464#7180454#6140410#6800452#7350380#7240498#6910512#7170507#7020490#6320392#6790369#6560557#6860427#6380442#6900519#5910415#6230533#6860525#5850386#6600465#5880379#6760536#6740359#6090430#5940387#6830510#7040479#6330375#6940507#6940387#5890375#5890383#7220471#6140542#5960365#6230515#6040410#6190487#6540432#7560380#6590415#6520555#6710536#6790462#5850420#5850427#7080512#6350415#6460454#6340556#7030535#6750500#7040554#6820368#6870476#7130518#6880450#6700469#6760494#7310385#5970381#6900544#6990394#7100529#6640399#7260486#6580539#6040390#6870405#6730556#5980391#7170519#6870382#6300542#6380393#7290468#5960371#7040360#6030381#6720488#6750473#7040372#6700454#6380399#6730412#6350550#6740547#5870404#6080413#6060361#6600386#6990381';
        const ticketLandIds = ticketlandIdsStr.split("#");

        console.debug("mint ticketland");
        let aj = 0;
        var i, j, temporary, chunk = 10;
        for (i = 0, j = ticketLandIds.length; i < j; i += chunk) {
            temporary = ticketLandIds.slice(i, i + chunk);

            // console.debug("开始上架ticket land ids", temporary.length, '已经上传:', aj);

            // await Meland1155LandI.mintBatch(accounts[0], temporary, temporary.map(() => 1), asciiToHex("ticketland"));

            aj += temporary.length;
            
        }
        console.debug("mint ticketland done.");

        const tierCids = Object.keys(map);

        console.debug("mint wearable");
        for (let i = 0; i < tierCids.length; i++) {
            const tierPoolId = tierCids[i];
            const options = map[tierPoolId];
            for (let j = 0; j < options.length; j++) {
                const op = options[j];
                let { cids, num } = op;
                const rewards = [];
                for (let q = 0; q < cids.length; q++) {
                    const cid = cids[q];
                    const tokenIds = (await Meland1155WearableI.mint(accounts[0], cid, num)).logs.map(log => log.args.id.toString());
                    console.debug("mint wearable", cid, num, rewards, tokenIds, tokenIds.length);
                    rewards.push(tokenIds);
                }

                while (num > 0) {
                    num--;
                    // const tid = ticketLandIds.pop();

                    // if (!tid) {
                    //     break;
                    // }

                    // console.debug("add ticket land reward", tid, 1);
                    // await MelandTierI.add100PercentReward(tierPoolId, [
                    //     {
                    //         erc1155: Meland1155LandI.address,
                    //         tokenIds: [tid],
                    //         amounts: [1]
                    //     }
                    // ], [], []);

                    const tokenIds = [
                        rewards[0].pop(),
                        rewards[1].pop(),
                        rewards[2].pop(),
                        rewards[3].pop(),
                    ];
                    const amounts = tokenIds.map(() => 1);
                    console.debug("add option reward", tokenIds, amounts);
                    await MelandTierI.addOptionReward(tierPoolId, [
                        {
                            erc1155: Meland1155WearableI.address,
                            tokenIds: tokenIds,
                            amounts: amounts
                        }
                    ], [], []);
                }
            }
        }
        console.debug("mint wearable done...");

        callback();
    } catch (error) {
        console.error(error);
        console.log(JSON.stringify(ticketLandIds));
        callback();
    }
};